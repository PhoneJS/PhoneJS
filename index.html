<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Visualização da Lista Firebase</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
    html, body { height: 100%; width: 100%; background: #f5f5f5; }
    #topbar {
      position: fixed; top: 0; left: 0; width: 100%;
      background: #222; color: #fff; padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 1000;
    }
    #topbar h1 { font-size: 18px; }
    #icon {
      cursor: pointer;
      width: 32px; height: 32px;
      background: url('https://cdn-icons-png.flaticon.com/512/1828/1828774.png') no-repeat center;
      background-size: contain;
    }
    #list {
      margin-top: 60px;
      height: calc(100% - 60px);
      overflow-y: auto;
      padding: 10px;
      background: #fff;
    }
    .item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .item span { font-weight: normal; color: #333; }

    #dialog {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      width: 320px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    #dialog h2 { margin-bottom: 15px; color: #222; font-size: 20px; }
    #dialog input[type="text"],
    #dialog input[type="number"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #aaa;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    #dialog label {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    #dialog label input { margin-right: 10px; }

    #dialog .buttons {
      display: flex;
      justify-content: space-between;
    }

    #dialog button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #dialog .fechar { background: #ccc; color: #000; }
    #dialog .enviar { background: #28a745; color: #fff; }

    #loading {
      text-align: center;
      color: #777;
      padding: 15px;
    }
  </style>
</head>
<body>

  <div id="topbar">
    <h1>Ranking de Lista Firebase</h1>
    <div id="icon" title="Nova Configuração"></div>
  </div>

  <div id="list">
    <div id="list-container"><div id="loading">Carregando lista...</div></div>
  </div>

  <div id="dialog">
    <h2>Nova Configuração</h2>
    <input type="number" id="indexInput" placeholder="Número do usuário (1-999)" min="1" max="999" />
    <input type="text" id="urlInput" placeholder="Digite a URL" />
    <label><input type="checkbox" id="onToggle" /> Ativar chave "ON"</label>
    <div class="buttons">
      <button class="fechar" onclick="fecharDialog()">Fechar</button>
      <button class="enviar" onclick="enviarConfiguracao()" id="enviarBtn">Enviar</button>
    </div>
  </div>

  <script>
    const base = "https://phonejs-5ef09-default-rtdb.firebaseio.com/Phone";
    const listContainer = document.getElementById('list-container');
    const enviarBtn = document.getElementById('enviarBtn');

    async function carregarLista() {
      listContainer.innerHTML = '<div id="loading">Carregando lista...</div>';
      for (let i = 1; i <= 999; i++) {
        try {
          const res = await fetch(`${base}/${i}.json`);
          if (!res.ok) continue;
          const data = await res.json();
          if (!data) continue;

          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div><strong>#${i}</strong></div>
            <span><b>IP:</b> ${data.IP || '---'}</span>
            <span><b>URL:</b> ${data.URL || '---'}</span>
            <span><b>TMP:</b> ${data.TMP || '---'}</span>
            <span><b>ON:</b> ${data.ON === true ? 'true' : (data.ON === false ? 'false' : '---')}</span>
          `;
          listContainer.appendChild(div);
        } catch (e) {
          console.error("Erro ao buscar", i, e);
        }
      }
      const loading = document.getElementById('loading');
      if (loading) loading.remove();
    }

    function getTimestamp() {
      const now = new Date();
      const p = n => n.toString().padStart(2, "0");
      return p(now.getDate()) + p(now.getMonth() + 1) + now.getFullYear().toString().slice(-2) + p(now.getHours()) + p(now.getMinutes());
    }

    async function encontrarIndiceDisponivel() {
      for (let i = 1; i <= 999; i++) {
        try {
          const res = await fetch(`${base}/${i}.json`);
          if (!res.ok) continue;
          const data = await res.json();
          if (!data) return i;
        } catch {
          // Ignorar erros aqui
        }
      }
      return null;
    }

    async function enviarConfiguracao() {
      const url = document.getElementById('urlInput').value.trim();
      const on = document.getElementById('onToggle').checked;
      const TMP = getTimestamp();
      let index = parseInt(document.getElementById('indexInput').value);

      if (!url) return alert("Digite uma URL válida.");

      enviarBtn.disabled = true;
      enviarBtn.textContent = "Enviando...";

      if (!index || index < 1 || index > 999) {
        index = await encontrarIndiceDisponivel();
        if (!index) {
          alert("Não há espaço disponível na lista.");
          enviarBtn.disabled = false;
          enviarBtn.textContent = "Enviar";
          return;
        }
      }

      const dados = { URL: url, ON: on, TMP };

      try {
        const res = await fetch(`${base}/${index}.json`, {
          method: "PUT", // PUT para garantir criação do nó
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dados)
        });

        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);

        alert(`Configuração enviada para o número ${index}!`);
        fecharDialog();
        carregarLista();
      } catch (err) {
        alert("Erro ao enviar dados: " + err.message);
        console.error("Erro no envio:", err);
      } finally {
        enviarBtn.disabled = false;
        enviarBtn.textContent = "Enviar";
      }
    }

    document.getElementById('icon').onclick = () => {
      document.getElementById('dialog').style.display = 'block';
    };

    function fecharDialog() {
      document.getElementById('dialog').style.display = 'none';
      document.getElementById('urlInput').value = '';
      document.getElementById('indexInput').value = '';
      document.getElementById('onToggle').checked = false;
    }

    carregarLista();
  </script>

</body>
</html>